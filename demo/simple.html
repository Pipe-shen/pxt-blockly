<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>demo</title>
  <script src="../blockly_compressed.js"></script>
  <script src="../javascript_compressed.js"></script>
  <script src="../msg/js/en.js"></script>
  <script src="../blocks_compressed.js"></script>
  <style>
  html,body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
  }
  #blocklyDiv,#fun {
    width: 50%;
    height: 100%;
    float: left;
  }
  button {
    margin-right: 10px;
  }
  .btn-tab.active {
    background-color: #5ba55b;
    color: #fff;
  }
  .btn-tab.selected {
    border-bottom: 5px solid rgb(38, 0, 255);    
  }
  </style>
</head>
<body>
  <div id="blocklyDiv"></div>
  <div id="fun">
    <div class="">buttons</div>
    <div class="">
        <!-- <button type="button" onclick="toXml()">to xml</button> -->
        <!-- <button type="button" onclick="toBlock()">xml to block</button> -->
        <button type="button" onclick="addTab()">new tab</button>
        <button type="button" onclick="removeTab()">remove tab</button>
    </div>
    <br>
    <div class="">tabs</div>
    <div id="tabs">

    </div>
    <br>
    <div class="">var maps</div>
    <div id="map">

    </div>
    <br>
    <div class="">var list</div>
    <div id="list">

    </div>
  </div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <category name="If">
        <block type="controls_if"></block>
        <block type="controls_if">
          <mutation else="1"></mutation>
        </block>
        <block type="controls_if">
          <mutation elseif="1" else="1"></mutation>
        </block>
      </category>
      <category name="Boolean" colour="%{BKY_LOGIC_HUE}">
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
        <block type="logic_null"></block>
        <block type="logic_ternary"></block>
      </category>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <field name="VAR">i</field>
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
        <value name="BY">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain">
        <value name="LOW">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="HIGH">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <value name="TO">
          <block type="math_number">
            <field name="NUM">100</field>
          </block>
        </value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2"></block>
    </category>
    <category name="Lists" colour="%{BKY_LISTS_HUE}">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">5</field>
          </block>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
    </category>
    <sep></sep>
    <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
    </category>
    <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
    </category>
    <sep></sep>
    <category name="Library" expanded="true">
      <category name="Randomize">
        <block type="procedures_defnoreturn">
          <mutation>
            <arg name="list"></arg>
          </mutation>
          <field name="NAME">randomize</field>
          <statement name="STACK">
            <block type="controls_for" inline="true">
              <field name="VAR">x</field>
              <value name="FROM">
                <block type="math_number">
                  <field name="NUM">1</field>
                </block>
              </value>
              <value name="TO">
                <block type="lists_length" inline="false">
                  <value name="VALUE">
                    <block type="variables_get">
                      <field name="VAR">list</field>
                    </block>
                  </value>
                </block>
              </value>
              <value name="BY">
                <block type="math_number">
                  <field name="NUM">1</field>
                </block>
              </value>
              <statement name="DO">
                <block type="variables_set" inline="false">
                  <field name="VAR">y</field>
                  <value name="VALUE">
                    <block type="math_random_int" inline="true">
                      <value name="FROM">
                        <block type="math_number">
                          <field name="NUM">1</field>
                        </block>
                      </value>
                      <value name="TO">
                        <block type="lists_length" inline="false">
                          <value name="VALUE">
                            <block type="variables_get">
                              <field name="VAR">list</field>
                            </block>
                          </value>
                        </block>
                      </value>
                    </block>
                  </value>
                  <next>
                    <block type="variables_set" inline="false">
                      <field name="VAR">temp</field>
                      <value name="VALUE">
                        <block type="lists_getIndex" inline="true">
                          <mutation statement="false" at="true"></mutation>
                          <field name="MODE">GET</field>
                          <field name="WHERE">FROM_START</field>
                          <value name="AT">
                            <block type="variables_get">
                              <field name="VAR">y</field>
                            </block>
                          </value>
                          <value name="VALUE">
                            <block type="variables_get">
                              <field name="VAR">list</field>
                            </block>
                          </value>
                        </block>
                      </value>
                      <next>
                        <block type="lists_setIndex" inline="false">
                          <value name="AT">
                            <block type="variables_get">
                              <field name="VAR">y</field>
                            </block>
                          </value>
                          <value name="LIST">
                            <block type="variables_get">
                              <field name="VAR">list</field>
                            </block>
                          </value>
                          <value name="TO">
                            <block type="lists_getIndex" inline="true">
                              <mutation statement="false" at="true"></mutation>
                              <field name="MODE">GET</field>
                              <field name="WHERE">FROM_START</field>
                              <value name="AT">
                                <block type="variables_get">
                                  <field name="VAR">x</field>
                                </block>
                              </value>
                              <value name="VALUE">
                                <block type="variables_get">
                                  <field name="VAR">list</field>
                                </block>
                              </value>
                            </block>
                          </value>
                          <next>
                            <block type="lists_setIndex" inline="false">
                              <value name="AT">
                                <block type="variables_get">
                                  <field name="VAR">x</field>
                                </block>
                              </value>
                              <value name="LIST">
                                <block type="variables_get">
                                  <field name="VAR">list</field>
                                </block>
                              </value>
                              <value name="TO">
                                <block type="variables_get">
                                  <field name="VAR">temp</field>
                                </block>
                              </value>
                            </block>
                          </next>
                        </block>
                      </next>
                    </block>
                  </next>
                </block>
              </statement>
            </block>
          </statement>
        </block>
      </category>
      <category name="Jabberwocky">
        <block type="text_print">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">'Twas brillig, and the slithy toves</field>
            </block>
          </value>
          <next>
            <block type="text_print">
              <value name="TEXT">
                <block type="text">
                  <field name="TEXT">  Did gyre and gimble in the wabe:</field>
                </block>
              </value>
              <next>
                <block type="text_print">
                  <value name="TEXT">
                    <block type="text">
                      <field name="TEXT">All mimsy were the borogroves,</field>
                    </block>
                  </value>
                  <next>
                    <block type="text_print">
                      <value name="TEXT">
                        <block type="text">
                          <field name="TEXT">  And the mome raths outgrabe.</field>
                        </block>
                      </value>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
        <block type="text_print">
          <value name="TEXT">
            <block type="text">
              <field name="TEXT">"Beware the Jabberwock, my son!</field>
            </block>
          </value>
          <next>
            <block type="text_print">
              <value name="TEXT">
                <block type="text">
                  <field name="TEXT">  The jaws that bite, the claws that catch!</field>
                </block>
              </value>
              <next>
                <block type="text_print">
                  <value name="TEXT">
                    <block type="text">
                      <field name="TEXT">Beware the Jubjub bird, and shun</field>
                    </block>
                  </value>
                  <next>
                    <block type="text_print">
                      <value name="TEXT">
                        <block type="text">
                          <field name="TEXT">  The frumious Bandersnatch!"</field>
                        </block>
                      </value>
                    </block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </category>
    </category>
  </xml>

  <script>
    var workspace = null
    var dom = null
    var workspaceId = 0
    var workspaceArr = []
    var activeIndex = 0
    var varListDom = []

    workspace = Blockly.inject('blocklyDiv',{
      grid: {
        spacing: 25,
        length: 3,
        colour: '#ccc',
        snap: true
      },
      zoom: {
        controls: true,
        wheel: true,
        startScale: 1.0,
        maxScale: 4,
        minScale: 0.25,
        scaleSpeed: 1.1
      },
      media: '../media/',
      toolbox: document.getElementById('toolbox')
    })

    workspace.addChangeListener(logger);

    function logger(e){
      console.log(e)
      console.log(activeIndex)
      console.log(workspaceArr)
      workspaceArr[activeIndex].xml = toXml()
      getVarMap()
      getAllVarByBlock()
    }
    // 删除当前激活的，并切换到前一个
    function removeTab(){
      if(workspaceArr.length==1) return;
      workspaceArr.splice(activeIndex, 1)
      document.querySelector('.active').remove()
      setTabActive(workspaceArr[activeIndex-1].workspaceId)
    }
    // tab functions
    function addTab(){
      let tabsDom = document.querySelector('#tabs')
      tabsDom.innerHTML += '<button type="button" class="btn-tab" id="tab' + workspaceId + '" onclick="setTabActive(\''+workspaceId+'\')">tab' + workspaceId + '   </button>'
      workspaceArr.push({
        id: 'tab'+workspaceId,
        workspaceId: workspaceId,
        xml: null
      })
      
      setTabActive(workspaceId)
      workspaceId++
    }
    
    function setTabActive(workspaceId){
      clearAll()      
      let elActive = document.querySelector('.active')
      if(elActive) {
        elActive.className = 'btn-tab' + (elActive.className.indexOf('selected')>-1?' selected':'')
      }
      let newActive = document.querySelector('#tab' + workspaceId)
      newActive.className = 'btn-tab active' + (newActive.className.indexOf('selected')>-1?' selected':'')

      workspaceArr.map((item, index)=>{
        if(item.id == 'tab'+workspaceId){
          activeIndex = index
          toBlock(item.xml)
          toAllVar()
        }
      })
    }
    function clearAll(){
      varListDom = Blockly.Xml.variablesToDom(workspace.getAllVariables())
      workspace.clear()
    }
    function toXml(){
      dom = Blockly.Xml.workspaceToDom(workspace)
      console.log(dom)
      return dom
    }
    function toBlock(dom){
      if(dom){
        Blockly.Xml.domToWorkspace(dom, workspace)
      }
    }
    
    // var functions
    function toAllVar(){
      Blockly.Xml.domToVariables(varListDom, workspace)
    }
    function getAllVarByBlock(){
      var varIds = []
      var list = document.querySelector('#list')
      list.innerHTML = ''
      workspace.getAllBlocks().map((item, index)=>{
        if(item.type.indexOf('variables')>-1){
          varIds.push(item.id)
          console.log(item)
          var varBlock = item.getVarModels()[0]
          list.innerHTML += '<button type="button" var-id="'+item.id+'" block-id="'+varBlock.id+'" onclick="centerVar(\''+item.id+'\')">' + varBlock.name + '</button>' 
        }
      })
      console.log(varIds)
    }
    function centerVar(id){
      centerOnVar(id)
      highlightOnVar(id)
      // TODO selected
      // workspace.getBlockById(id).selected = true
    }
    function centerOnVar(id){
      workspace.centerOnBlock(id, true);
    }

    function highlightOnVar(id) {
      workspace.highlightBlock(id);
    }


    function getVarMap(){
      document.querySelector('#map').innerHTML = ''
      workspace.getAllVariables().map((x)=>{
        document.querySelector('#map').innerHTML += '<button type="button" var-id="'+x.getId()+'" onclick="findTabByVarName(\''+x.name+'\')">' + x.name + '</button>'
      })
    }
    function findTabByVarName(name){
      document.querySelectorAll('.selected').forEach(x=>{
        x.className = x.className.split('selected').join('')
      })
      workspaceArr.map((item, index)=>{
        var xmlString = Blockly.Xml.domToText(item.xml)
        if(xmlString.indexOf('>'+name+'</field')>-1){
          // 当前 tab 存在这个变量
          document.querySelector('#' + item.id).className += ' selected' 
        }
      })
    }

    addTab()
  </script>
</body> 
</html>
